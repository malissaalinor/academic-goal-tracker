<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Academic Goal Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const SUPABASE_URL = "https://qsmwntezeumnnlxhemiu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzbXdudGV6ZXVtbm5seGhlbWl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzY1NDYsImV4cCI6MjA4NzU1MjU0Nn0.PApvzpPmcqpg7SxRgaXtU5FJgMkGEExMF1A6qE-d1Qg";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const STATUSES = ["Active", "Paused", "Done", "Rejected/Redirected"];
    const OUTCOMES = ["N/A", "Accepted", "Under Review", "Revise & Resubmit", "Rejected"];
    const SUB_TYPES = ["General", "Journal Article", "Conference Paper", "Book Chapter", "Grant"];
    const CATEGORIES = ["Research", "Teaching", "Service", "Writing", "Other"];
    const PRIORITIES = ["High", "Medium", "Low"];
    const TIME_CATS = ["Research", "Teaching", "Service"];

    const statusColors = {
      Active: "bg-emerald-100 text-emerald-800",
      Paused: "bg-yellow-100 text-yellow-800",
      Done: "bg-blue-100 text-blue-800",
      "Rejected/Redirected": "bg-red-100 text-red-800",
    };
    const outcomeColors = {
      "N/A": "bg-slate-100 text-slate-500",
      Accepted: "bg-emerald-100 text-emerald-700",
      "Under Review": "bg-blue-100 text-blue-700",
      "Revise & Resubmit": "bg-yellow-100 text-yellow-700",
      Rejected: "bg-red-100 text-red-700",
    };
    const priorityColors = {
      High: "bg-red-100 text-red-700",
      Medium: "bg-orange-100 text-orange-700",
      Low: "bg-gray-100 text-gray-600",
    };
    const timeCatColors = {
      Research: "bg-violet-100 text-violet-700",
      Teaching: "bg-sky-100 text-sky-700",
      Service: "bg-amber-100 text-amber-700",
      Other: "bg-gray-100 text-gray-600",
      Writing: "bg-pink-100 text-pink-700",
    };

    function daysUntil(d) { if (!d) return null; return Math.ceil((new Date(d) - new Date()) / 86400000); }
    function DeadlineBadge({ date }) {
      const d = daysUntil(date);
      if (d === null) return null;
      if (d < 0) return <span className="text-xs bg-red-200 text-red-800 px-2 py-0.5 rounded-full">Overdue</span>;
      if (d <= 7) return <span className="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded-full">Due in {d}d</span>;
      return <span className="text-xs text-gray-400">{date}</span>;
    }
    function Field({ label, children }) {
      return <div><label className="block text-xs font-medium text-slate-500 mb-1">{label}</label>{children}</div>;
    }
    function Modal({ title, children, onClose }) {
      return (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50 px-4">
          <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 max-h-screen overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-semibold text-slate-800">{title}</h3>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-600">‚úï</button>
            </div>
            {children}
          </div>
        </div>
      );
    }

    const emptyGoal = () => ({ id: Date.now(), title: "", category: "Research", status: "Active", deadline: "", progress: 0, notes: "", outcome: "N/A", sub_type: "General" });
    const emptyTask = (gid) => ({ id: Date.now(), goal_id: gid, title: "", priority: "Medium", deadline: "", done: false, est_hours: "", actual_hours: 0, time_category: "Research" });
    const DEFAULT_BUDGETS = { Research: 25, Teaching: 10, Service: 5 };
    const POMO_WORK = 25 * 60, POMO_BREAK = 5 * 60;

    // ‚îÄ‚îÄ Auth Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function AuthScreen() {
      const [mode, setMode] = useState("login"); // login | signup | reset
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [error, setError] = useState("");
      const [message, setMessage] = useState("");
      const [loading, setLoading] = useState(false);

      const submit = async () => {
        setError(""); setMessage(""); setLoading(true);
        if (mode === "login") {
          const { error: e } = await sb.auth.signInWithPassword({ email, password });
          if (e) setError(e.message);
        } else if (mode === "signup") {
          const { error: e } = await sb.auth.signUp({ email, password });
          if (e) setError(e.message);
          else setMessage("Account created! Check your email to confirm, then log in.");
        } else {
          const { error: e } = await sb.auth.resetPasswordForEmail(email);
          if (e) setError(e.message);
          else setMessage("Password reset email sent!");
        }
        setLoading(false);
      };

      return (
        <div className="min-h-screen bg-slate-50 flex items-center justify-center px-4">
          <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8">
            <div className="text-center mb-6">
              <div className="text-4xl mb-2">üéì</div>
              <h1 className="text-xl font-semibold text-slate-800">Academic Goal Tracker</h1>
              <p className="text-sm text-slate-400 mt-1">{mode === "login" ? "Sign in to your account" : mode === "signup" ? "Create an account" : "Reset your password"}</p>
            </div>
            {error && <div className="bg-red-50 text-red-700 text-sm px-3 py-2 rounded-lg mb-4">{error}</div>}
            {message && <div className="bg-emerald-50 text-emerald-700 text-sm px-3 py-2 rounded-lg mb-4">{message}</div>}
            <div className="space-y-3">
              <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)}
                className="w-full border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300" />
              {mode !== "reset" && (
                <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)}
                  onKeyDown={e => e.key === "Enter" && submit()}
                  className="w-full border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300" />
              )}
              <button onClick={submit} disabled={loading}
                className="w-full bg-slate-800 text-white py-2.5 rounded-lg text-sm font-medium hover:bg-slate-700 disabled:opacity-50">
                {loading ? "Please wait..." : mode === "login" ? "Sign In" : mode === "signup" ? "Create Account" : "Send Reset Email"}
              </button>
            </div>
            <div className="mt-4 text-center space-y-2">
              {mode === "login" && <>
                <button onClick={() => { setMode("signup"); setError(""); setMessage(""); }} className="block w-full text-xs text-slate-500 hover:text-slate-700">Don't have an account? Sign up</button>
                <button onClick={() => { setMode("reset"); setError(""); setMessage(""); }} className="block w-full text-xs text-slate-400 hover:text-slate-600">Forgot password?</button>
              </>}
              {(mode === "signup" || mode === "reset") && (
                <button onClick={() => { setMode("login"); setError(""); setMessage(""); }} className="block w-full text-xs text-slate-500 hover:text-slate-700">Back to sign in</button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function TrackerApp({ user }) {
      const [goals, setGoals] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [budgets, setBudgets] = useState(DEFAULT_BUDGETS);
      const [meetings, setMeetings] = useState(0);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      const [view, setView] = useState("goals");
      const [editGoal, setEditGoal] = useState(null);
      const [editTask, setEditTask] = useState(null);
      const [showGoalForm, setShowGoalForm] = useState(false);
      const [showTaskForm, setShowTaskForm] = useState(false);
      const [expandedGoal, setExpandedGoal] = useState(null);
      const [copied, setCopied] = useState(false);

      const [pomoOpen, setPomoOpen] = useState(false);
      const [pomoMode, setPomoMode] = useState("work");
      const [pomoTime, setPomoTime] = useState(POMO_WORK);
      const [pomoRunning, setPomoRunning] = useState(false);
      const [pomoTaskId, setPomoTaskId] = useState("");
      const [pomoElapsed, setPomoElapsed] = useState(0);
      const pomoRef = useRef(null);
      const pomoModeRef = useRef("work");

      useEffect(() => {
        async function load() {
          setLoading(true);
          const [{ data: g }, { data: t }, { data: s }] = await Promise.all([
            sb.from("goals").select("*").eq("user_id", user.id),
            sb.from("tasks").select("*").eq("user_id", user.id),
            sb.from("settings").select("*").eq("user_id", user.id),
          ]);
          if (g) setGoals(g);
          if (t) setTasks(t);
          if (s) {
            const b = s.find(x => x.key === "budgets");
            const m = s.find(x => x.key === "meetings");
            if (b) setBudgets(JSON.parse(b.value));
            if (m) setMeetings(parseFloat(m.value) || 0);
          }
          setLoading(false);
        }
        load();
      }, [user.id]);

      useEffect(() => { pomoModeRef.current = pomoMode; }, [pomoMode]);
      useEffect(() => {
        if (pomoRunning) {
          pomoRef.current = setInterval(() => {
            setPomoTime(t => {
              if (t <= 1) {
                const next = pomoModeRef.current === "work" ? "break" : "work";
                setPomoMode(next);
                return next === "break" ? POMO_BREAK : POMO_WORK;
              }
              return t - 1;
            });
            setPomoElapsed(e => e + 1);
          }, 1000);
        } else { clearInterval(pomoRef.current); }
        return () => clearInterval(pomoRef.current);
      }, [pomoRunning]);

      const saveSetting = async (key, value) => {
        await sb.from("settings").upsert({ key, value: String(value), user_id: user.id }, { onConflict: "key,user_id" });
      };
      const updateBudgets = async (b) => { setBudgets(b); await saveSetting("budgets", JSON.stringify(b)); };
      const updateMeetings = async (m) => { setMeetings(m); await saveSetting("meetings", m); };

      const saveGoal = async (g) => {
        setSaving(true);
        const row = { id: g.id, user_id: user.id, title: g.title, category: g.category, status: g.status, deadline: g.deadline || null, progress: g.progress, notes: g.notes, outcome: g.outcome, sub_type: g.sub_type };
        const { data } = await sb.from("goals").upsert(row, { onConflict: "id" }).select();
        if (data) setGoals(gs => gs.find(x => x.id === g.id) ? gs.map(x => x.id === g.id ? data[0] : x) : [...gs, data[0]]);
        setSaving(false); setShowGoalForm(false); setEditGoal(null);
      };
      const deleteGoal = async (id) => {
        await sb.from("goals").delete().eq("id", id);
        setGoals(gs => gs.filter(g => g.id !== id));
        setTasks(ts => ts.filter(t => t.goal_id !== id));
      };
      const saveTask = async (t) => {
        setSaving(true);
        const row = { id: t.id, user_id: user.id, goal_id: t.goal_id || null, title: t.title, priority: t.priority, deadline: t.deadline || null, done: t.done, est_hours: t.est_hours ? parseFloat(t.est_hours) : null, actual_hours: parseFloat(t.actual_hours) || 0, time_category: t.time_category };
        const { data } = await sb.from("tasks").upsert(row, { onConflict: "id" }).select();
        if (data) setTasks(ts => ts.find(x => x.id === t.id) ? ts.map(x => x.id === t.id ? data[0] : x) : [...ts, data[0]]);
        setSaving(false); setShowTaskForm(false); setEditTask(null);
      };
      const deleteTask = async (id) => {
        await sb.from("tasks").delete().eq("id", id);
        setTasks(ts => ts.filter(t => t.id !== id));
      };
      const toggleTask = async (id) => {
        const t = tasks.find(x => x.id === id);
        if (!t) return;
        const updated = { ...t, done: !t.done };
        await sb.from("tasks").update({ done: updated.done }).eq("id", id);
        setTasks(ts => ts.map(x => x.id === id ? updated : x));
      };
      const pomoStop = async () => {
        setPomoRunning(false);
        if (pomoTaskId && pomoElapsed > 0) {
          const hrs = parseFloat((pomoElapsed / 3600).toFixed(2));
          const t = tasks.find(x => x.id === Number(pomoTaskId));
          if (t) {
            const newActual = parseFloat(((t.actual_hours || 0) + hrs).toFixed(2));
            await sb.from("tasks").update({ actual_hours: newActual }).eq("id", t.id);
            setTasks(ts => ts.map(x => x.id === t.id ? { ...x, actual_hours: newActual } : x));
          }
        }
        setPomoElapsed(0); setPomoTime(POMO_WORK); setPomoMode("work");
      };
      const pomoReset = () => { setPomoRunning(false); setPomoTime(POMO_WORK); setPomoMode("work"); setPomoElapsed(0); };
      const fmtTime = (s) => `${String(Math.floor(s / 60)).padStart(2, "0")}:${String(s % 60).padStart(2, "0")}`;

      const totalBudget = Object.values(budgets).reduce((a, b) => a + b, 0);
      const availableTotal = Math.max(0, totalBudget - meetings);
      const meetingRatio = totalBudget > 0 ? meetings / totalBudget : 0;
      const available = {};
      TIME_CATS.forEach(c => { available[c] = parseFloat((budgets[c] * (1 - meetingRatio)).toFixed(1)); });
      const estByCategory = {}, actByCategory = {};
      TIME_CATS.forEach(c => { estByCategory[c] = 0; actByCategory[c] = 0; });
      tasks.forEach(t => {
        const c = t.time_category;
        if (estByCategory[c] !== undefined) {
          estByCategory[c] += parseFloat(t.est_hours || 0);
          actByCategory[c] += parseFloat(t.actual_hours || 0);
        }
      });

      const generateSummary = () => {
        let out = `ACADEMIC SEMESTER SUMMARY\n${new Date().getFullYear()} Semester\nGenerated: ${new Date().toLocaleDateString()}\n${"=".repeat(50)}\n\n`;
        ["Research","Teaching","Service"].forEach(cat => {
          const catGoals = goals.filter(g => g.category === cat);
          const catTasks = tasks.filter(t => t.time_category === cat);
          const act = parseFloat(actByCategory[cat].toFixed(1));
          const est = parseFloat(estByCategory[cat].toFixed(1));
          out += `${cat.toUpperCase()}\n${"‚îÄ".repeat(30)}\n`;
          out += `Tasks completed: ${catTasks.filter(t=>t.done).length}/${catTasks.length}  |  Hours: ${act} actual / ${est} estimated\n\n`;
          const accepted = catGoals.filter(g => g.outcome === "Accepted");
          if (accepted.length) { out += `‚úì ACCEPTED:\n`; accepted.forEach(g => out += `  ‚Ä¢ ${g.title}${g.sub_type !== "General" ? ` [${g.sub_type}]` : ""}\n`); out += "\n"; }
          const revise = catGoals.filter(g => g.outcome === "Revise & Resubmit");
          if (revise.length) { out += `‚Üª REVISE & RESUBMIT:\n`; revise.forEach(g => out += `  ‚Ä¢ ${g.title}${g.sub_type !== "General" ? ` [${g.sub_type}]` : ""}\n`); out += "\n"; }
          const review = catGoals.filter(g => g.outcome === "Under Review");
          if (review.length) { out += `‚ü≥ UNDER REVIEW:\n`; review.forEach(g => out += `  ‚Ä¢ ${g.title}${g.sub_type !== "General" ? ` [${g.sub_type}]` : ""}\n`); out += "\n"; }
          const done = catGoals.filter(g => g.status === "Done" && g.outcome === "N/A");
          if (done.length) { out += `‚úì COMPLETED:\n`; done.forEach(g => out += `  ‚Ä¢ ${g.title}\n`); out += "\n"; }
          const rejected = catGoals.filter(g => g.outcome === "Rejected" || g.status === "Rejected/Redirected");
          if (rejected.length) { out += `‚úó REJECTED/REDIRECTED:\n`; rejected.forEach(g => out += `  ‚Ä¢ ${g.title}${g.notes ? ` ‚Äî ${g.notes}` : ""}\n`); out += "\n"; }
          const active = catGoals.filter(g => g.status === "Active");
          if (active.length) { out += `‚Üí IN PROGRESS:\n`; active.forEach(g => out += `  ‚Ä¢ ${g.title} (${g.progress}%)\n`); out += "\n"; }
          out += "\n";
        });
        out += `OVERALL\n${"‚îÄ".repeat(30)}\n`;
        out += `Goals: ${goals.filter(g=>g.status==="Done").length}/${goals.length} completed  |  Accepted: ${goals.filter(g=>g.outcome==="Accepted").length}\n`;
        out += `Tasks: ${tasks.filter(t=>t.done).length}/${tasks.length} completed\n`;
        out += `Total hours (actual): ${Object.values(actByCategory).reduce((a,b)=>a+b,0).toFixed(1)}\n`;
        return out;
      };
      const copyToClipboard = () => {
        navigator.clipboard.writeText(generateSummary()).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
      };

      const activeGoals = goals.filter(g => g.status === "Active");
      const doneTasks = tasks.filter(t => t.done).length;

      if (loading) return (
        <div className="min-h-screen bg-slate-50 flex items-center justify-center">
          <div className="text-center text-slate-400"><div className="text-4xl mb-3">üéì</div><p>Loading your data...</p></div>
        </div>
      );

      return (
        <div className="min-h-screen bg-slate-50 font-sans">
          {saving && <div className="fixed top-4 right-4 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-full z-50">Saving...</div>}

          <div className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
            <div>
              <h1 className="text-xl font-semibold text-slate-800">Academic Goal Tracker</h1>
              <p className="text-sm text-slate-400">Semester planner ¬∑ Weekly focus ¬∑ Time bank</p>
            </div>
            <div className="flex items-center gap-3">
              <div className="flex gap-1 bg-slate-100 rounded-lg p-1">
                {["goals","weekly","timebank","summary"].map(v => (
                  <button key={v} onClick={() => setView(v)}
                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${view === v ? "bg-white shadow text-slate-800" : "text-slate-500 hover:text-slate-700"}`}>
                    {v === "goals" ? "Semester Goals" : v === "weekly" ? "Weekly Tasks" : v === "timebank" ? "Time Bank" : "Summary"}
                  </button>
                ))}
              </div>
              <button onClick={() => sb.auth.signOut()} className="text-xs text-slate-400 hover:text-slate-600 border border-slate-200 px-3 py-1.5 rounded-lg">Sign out</button>
            </div>
          </div>

          <div className="max-w-4xl mx-auto px-6 py-6">
            <div className="grid grid-cols-4 gap-3 mb-6">
              {[
                { label: "Total Goals", val: goals.length, color: "text-slate-700" },
                { label: "Active", val: activeGoals.length, color: "text-emerald-600" },
                { label: "Done", val: goals.filter(g => g.status === "Done").length, color: "text-blue-600" },
                { label: "Tasks This Week", val: `${doneTasks}/${tasks.length}`, color: "text-orange-600" },
              ].map(s => (
                <div key={s.label} className="bg-white rounded-xl border border-slate-200 p-4">
                  <div className={`text-2xl font-bold ${s.color}`}>{s.val}</div>
                  <div className="text-xs text-slate-400 mt-0.5">{s.label}</div>
                </div>
              ))}
            </div>

            {view === "goals" && (
              <div>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-semibold text-slate-700">Semester Goals</h2>
                  <button onClick={() => { setEditGoal(emptyGoal()); setShowGoalForm(true); }} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">+ Add Goal</button>
                </div>
                {goals.length === 0 && <div className="text-center py-16 text-slate-400"><div className="text-4xl mb-3">üéì</div><p>No goals yet.</p></div>}
                <div className="space-y-3">
                  {goals.map(g => (
                    <div key={g.id} className="bg-white border border-slate-200 rounded-xl overflow-hidden">
                      <div className="p-4">
                        <div className="flex items-start justify-between gap-3">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap">
                              <span className="font-medium text-slate-800">{g.title || "Untitled"}</span>
                              <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${statusColors[g.status]}`}>{g.status}</span>
                              {g.sub_type !== "General" && <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">{g.sub_type}</span>}
                              <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${outcomeColors[g.outcome || "N/A"]}`}>{g.outcome || "N/A"}</span>
                              <DeadlineBadge date={g.deadline} />
                            </div>
                            <div className="mt-3 flex items-center gap-3">
                              <div className="flex-1 bg-slate-100 rounded-full h-2">
                                <div className="bg-emerald-500 h-2 rounded-full transition-all" style={{ width: `${g.progress}%` }} />
                              </div>
                              <span className="text-xs text-slate-400 w-8">{g.progress}%</span>
                            </div>
                            {g.notes && <p className="text-sm text-slate-500 mt-2 italic">{g.notes}</p>}
                          </div>
                          <div className="flex gap-1 shrink-0">
                            <button onClick={() => setExpandedGoal(expandedGoal === g.id ? null : g.id)} className="p-1.5 text-slate-400 hover:text-slate-600 text-xs">{expandedGoal === g.id ? "‚ñ≤" : "‚ñº"}</button>
                            <button onClick={() => { setEditGoal(g); setShowGoalForm(true); }} className="p-1.5 text-slate-400 hover:text-slate-600">‚úèÔ∏è</button>
                            <button onClick={() => deleteGoal(g.id)} className="p-1.5 text-slate-400 hover:text-red-500">üóë</button>
                          </div>
                        </div>
                      </div>
                      {expandedGoal === g.id && (
                        <div className="border-t border-slate-100 bg-slate-50 px-4 py-3">
                          <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Linked Tasks</span>
                            <button onClick={() => { setEditTask(emptyTask(g.id)); setShowTaskForm(true); }} className="text-xs text-slate-500 hover:text-slate-800 border border-slate-300 px-2 py-1 rounded-md">+ Task</button>
                          </div>
                          {tasks.filter(t => t.goal_id === g.id).length === 0 && <p className="text-xs text-slate-400">No tasks yet.</p>}
                          {tasks.filter(t => t.goal_id === g.id).map(t => (
                            <div key={t.id} className="flex items-center gap-2 py-1.5">
                              <input type="checkbox" checked={t.done} onChange={() => toggleTask(t.id)} className="rounded" />
                              <span className={`flex-1 text-sm ${t.done ? "line-through text-slate-400" : "text-slate-700"}`}>{t.title}</span>
                              <span className={`text-xs px-2 py-0.5 rounded-full ${priorityColors[t.priority]}`}>{t.priority}</span>
                              {t.est_hours && <span className="text-xs text-slate-400">Est: {t.est_hours}h</span>}
                              {t.actual_hours > 0 && <span className="text-xs text-emerald-600">Act: {t.actual_hours}h</span>}
                              <DeadlineBadge date={t.deadline} />
                              <button onClick={() => { setEditTask(t); setShowTaskForm(true); }} className="text-slate-300 hover:text-slate-500 text-xs">‚úèÔ∏è</button>
                              <button onClick={() => deleteTask(t.id)} className="text-slate-300 hover:text-red-400 text-xs">‚úï</button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {view === "weekly" && (
              <div>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-semibold text-slate-700">Weekly Tasks</h2>
                  <button onClick={() => { setEditTask(emptyTask(activeGoals[0]?.id || null)); setShowTaskForm(true); }} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">+ Add Task</button>
                </div>
                {tasks.length === 0 && <div className="text-center py-16 text-slate-400"><div className="text-4xl mb-3">üìã</div><p>No tasks yet.</p></div>}
                {["High","Medium","Low"].map(p => {
                  const pts = tasks.filter(t => t.priority === p);
                  if (!pts.length) return null;
                  return (
                    <div key={p} className="mb-5">
                      <div className="mb-2"><span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${priorityColors[p]}`}>{p} Priority</span></div>
                      <div className="space-y-2">
                        {pts.map(t => {
                          const goal = goals.find(g => g.id === t.goal_id);
                          const over = t.est_hours && t.actual_hours > parseFloat(t.est_hours);
                          return (
                            <div key={t.id} className={`bg-white border rounded-xl px-4 py-3 flex items-center gap-3 ${t.done ? "opacity-60" : "border-slate-200"}`}>
                              <input type="checkbox" checked={t.done} onChange={() => toggleTask(t.id)} className="rounded shrink-0" />
                              <div className="flex-1 min-w-0">
                                <span className={`text-sm font-medium ${t.done ? "line-through text-slate-400" : "text-slate-800"}`}>{t.title || "Untitled"}</span>
                                {goal && <span className="ml-2 text-xs text-slate-400">‚Üê {goal.title}</span>}
                                <div className="flex gap-3 mt-1">
                                  {t.est_hours && <span className="text-xs text-slate-400">Est: {t.est_hours}h</span>}
                                  {t.actual_hours > 0 && <span className={`text-xs font-medium ${over ? "text-red-500" : "text-emerald-600"}`}>Act: {t.actual_hours}h {over ? "‚ö†Ô∏è" : ""}</span>}
                                  {t.time_category && <span className={`text-xs px-1.5 py-0.5 rounded-full ${timeCatColors[t.time_category]}`}>{t.time_category}</span>}
                                </div>
                              </div>
                              <DeadlineBadge date={t.deadline} />
                              <button onClick={() => { setEditTask(t); setShowTaskForm(true); }} className="text-slate-300 hover:text-slate-500">‚úèÔ∏è</button>
                              <button onClick={() => deleteTask(t.id)} className="text-slate-300 hover:text-red-400">‚úï</button>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {view === "timebank" && (
              <div>
                <h2 className="text-lg font-semibold text-slate-700 mb-4">Time Bank</h2>
                <div className="bg-white border border-slate-200 rounded-xl p-4 mb-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-medium text-slate-700">Meetings this week</p>
                      <p className="text-xs text-slate-400">Deducted proportionally from all categories</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <input type="number" min="0" step="0.5" value={meetings} onChange={e => updateMeetings(parseFloat(e.target.value) || 0)} className="w-20 border border-slate-200 rounded-lg px-3 py-1.5 text-sm text-center" />
                      <span className="text-sm text-slate-500">hrs</span>
                    </div>
                  </div>
                  <div className="mt-2 text-sm text-slate-500">
                    Total budget: <span className="font-medium text-slate-700">{totalBudget}h</span> &nbsp;¬∑&nbsp; After meetings: <span className="font-medium text-emerald-600">{availableTotal}h available</span>
                  </div>
                </div>
                <div className="space-y-3 mb-4">
                  {TIME_CATS.map(c => {
                    const avail = available[c];
                    const est = parseFloat(estByCategory[c].toFixed(1));
                    const act = parseFloat(actByCategory[c].toFixed(1));
                    const estPct = avail > 0 ? Math.min(100, (est / avail) * 100) : 0;
                    const actPct = avail > 0 ? Math.min(100, (act / avail) * 100) : 0;
                    const surplus = parseFloat((avail - act).toFixed(1));
                    return (
                      <div key={c} className="bg-white border border-slate-200 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${timeCatColors[c]}`}>{c}</span>
                            <span className="text-sm text-slate-500">Budget:</span>
                            <input type="number" min="0" value={budgets[c]} onChange={e => updateBudgets({ ...budgets, [c]: parseFloat(e.target.value) || 0 })} className="w-16 border border-slate-200 rounded-lg px-2 py-1 text-sm text-center" />
                            <span className="text-xs text-slate-400">hrs</span>
                          </div>
                          <span className="text-sm font-medium text-slate-700">Available: {avail}h</span>
                        </div>
                        <div className="mb-1">
                          <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Estimated</span><span>{est}h / {avail}h</span></div>
                          <div className="bg-slate-100 rounded-full h-2"><div className="bg-violet-400 h-2 rounded-full" style={{ width: `${estPct}%` }} /></div>
                        </div>
                        <div className="mb-2">
                          <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Actual</span><span>{act}h / {avail}h</span></div>
                          <div className="bg-slate-100 rounded-full h-2"><div className={`h-2 rounded-full ${act > avail ? "bg-red-400" : "bg-emerald-400"}`} style={{ width: `${actPct}%` }} /></div>
                        </div>
                        <div className={`text-xs font-medium ${surplus >= 0 ? "text-emerald-600" : "text-red-500"}`}>{surplus >= 0 ? `+${surplus}h surplus` : `${surplus}h deficit`}</div>
                      </div>
                    );
                  })}
                </div>
                <div className="bg-slate-100 rounded-xl p-3 text-xs text-slate-500 text-center">Estimates and actuals are pulled from your weekly tasks.</div>
              </div>
            )}

            {view === "summary" && (
              <div>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-semibold text-slate-700">Semester Summary</h2>
                  <button onClick={copyToClipboard} className={`px-4 py-2 rounded-lg text-sm font-medium text-white transition-all ${copied ? "bg-emerald-500" : "bg-slate-800 hover:bg-slate-700"}`}>
                    {copied ? "‚úì Copied!" : "Copy to Clipboard"}
                  </button>
                </div>
                {["Research","Teaching","Service"].map(cat => {
                  const catGoals = goals.filter(g => g.category === cat);
                  const catTasks = tasks.filter(t => t.time_category === cat);
                  const act = parseFloat(actByCategory[cat].toFixed(1));
                  const est = parseFloat(estByCategory[cat].toFixed(1));
                  const accepted = catGoals.filter(g => g.outcome === "Accepted");
                  const inReview = catGoals.filter(g => g.outcome === "Under Review");
                  const revise = catGoals.filter(g => g.outcome === "Revise & Resubmit");
                  const completed = catGoals.filter(g => g.status === "Done" && g.outcome === "N/A");
                  const rejected = catGoals.filter(g => g.outcome === "Rejected" || g.status === "Rejected/Redirected");
                  const active = catGoals.filter(g => g.status === "Active");
                  return (
                    <div key={cat} className="bg-white border border-slate-200 rounded-xl p-5 mb-4">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="font-semibold text-slate-800">{cat}</h3>
                        <div className="flex gap-3 text-xs text-slate-500">
                          <span>Tasks: <strong className="text-slate-700">{catTasks.filter(t=>t.done).length}/{catTasks.length}</strong></span>
                          <span>Hours: <strong className="text-slate-700">{act}h / {est}h est</strong></span>
                        </div>
                      </div>
                      {accepted.length > 0 && <div className="mb-3"><div className="text-xs font-semibold text-emerald-700 mb-1">‚úì Accepted</div>{accepted.map(g => <div key={g.id} className="text-sm text-slate-700 ml-3">‚Ä¢ {g.title}{g.sub_type !== "General" ? <span className="ml-1 text-xs text-slate-400">[{g.sub_type}]</span> : ""}</div>)}</div>}
                      {revise.length > 0 && <div className="mb-3"><div className="text-xs font-semibold text-yellow-700 mb-1">‚Üª Revise & Resubmit</div>{revise.map(g => <div key={g.id} className="text-sm text-slate-700 ml-3">‚Ä¢ {g.title}{g.sub_type !== "General" ? <span className="ml-1 text-xs text-slate-400">[{g.sub_type}]</span> : ""}</div>)}</div>}
                      {inReview.length > 0 && <div className="mb-3"><div className="text-xs font-semibold text-blue-700 mb-1">‚ü≥ Under Review</div>{inReview.map(g => <div key={g.id} className="text-sm text-slate-700 ml-3">‚Ä¢ {g.title}{g.sub_type !== "General" ? <span className="ml-1 text-xs text-slate-400">[{g.sub_type}]</span> : ""}</div>)}</div>}
                      {completed.length > 0 && <div className="mb-3"><div className="text-xs font-semibold text-slate-600 mb-1">‚úì Completed</div>{completed.map(g => <div key={g.id} className="text-sm text-slate-700 ml-3">‚Ä¢ {g.title}</div>)}</div>}
                      {rejected.length > 0 && <div className="mb-3"><div className="text-xs font-semibold text-red-600 mb-1">‚úó Rejected / Redirected</div>{rejected.map(g => <div key={g.id} className="text-sm text-slate-700 ml-3">‚Ä¢ {g.title}{g.notes ? <span className="text-xs text-slate-400 ml-1">‚Äî {g.notes}</span> : ""}</div>)}</div>}
                      {active.length > 0 && <div className="mb-1"><div className="text-xs font-semibold text-slate-400 mb-1">‚Üí In Progress</div>{active.map(g => <div key={g.id} className="text-sm text-slate-500 ml-3">‚Ä¢ {g.title} ({g.progress}%)</div>)}</div>}
                      {catGoals.length === 0 && <p className="text-sm text-slate-400">No goals in this category.</p>}
                    </div>
                  );
                })}
                <div className="bg-slate-800 text-white rounded-xl p-5">
                  <h3 className="font-semibold mb-3">Overall</h3>
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div><div className="text-2xl font-bold">{goals.filter(g=>g.status==="Done").length}/{goals.length}</div><div className="text-xs text-slate-400">Goals completed</div></div>
                    <div><div className="text-2xl font-bold text-emerald-400">{goals.filter(g=>g.outcome==="Accepted").length}</div><div className="text-xs text-slate-400">Accepted</div></div>
                    <div><div className="text-2xl font-bold">{tasks.filter(t=>t.done).length}/{tasks.length}</div><div className="text-xs text-slate-400">Tasks done</div></div>
                  </div>
                </div>
              </div>
            )}
          </div>

          <button onClick={() => setPomoOpen(o => !o)} className="fixed bottom-6 right-6 w-14 h-14 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg text-2xl flex items-center justify-center z-40">üçÖ</button>
          {pomoOpen && (
            <div className="fixed bottom-24 right-6 bg-white rounded-2xl shadow-2xl border border-slate-200 w-72 p-5 z-40">
              <div className="flex justify-between items-center mb-3">
                <span className="font-semibold text-slate-800">Pomodoro Timer</span>
                <button onClick={() => setPomoOpen(false)} className="text-slate-400 hover:text-slate-600">‚úï</button>
              </div>
              <div className="flex gap-2 mb-4">
                {["work","break"].map(m => (
                  <div key={m} className={`flex-1 text-center py-1 rounded-lg text-xs font-medium ${pomoMode === m ? (m === "work" ? "bg-red-100 text-red-700" : "bg-emerald-100 text-emerald-700") : "bg-slate-100 text-slate-400"}`}>
                    {m === "work" ? "üéØ Work" : "‚òï Break"}
                  </div>
                ))}
              </div>
              <div className="text-center mb-4">
                <div className="text-5xl font-mono font-bold text-slate-800">{fmtTime(pomoTime)}</div>
                {pomoElapsed > 0 && <div className="text-xs text-slate-400 mt-1">Elapsed: {fmtTime(pomoElapsed)}</div>}
              </div>
              <div className="mb-4">
                <label className="text-xs text-slate-500 mb-1 block">Working on</label>
                <select value={pomoTaskId} onChange={e => setPomoTaskId(e.target.value)} className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm">
                  <option value="">‚Äî Select a task ‚Äî</option>
                  {tasks.filter(t => !t.done).map(t => <option key={t.id} value={t.id}>{t.title}</option>)}
                </select>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setPomoRunning(r => !r)} className={`flex-1 py-2 rounded-lg text-sm font-medium text-white ${pomoRunning ? "bg-yellow-500 hover:bg-yellow-600" : "bg-red-500 hover:bg-red-600"}`}>
                  {pomoRunning ? "‚è∏ Pause" : "‚ñ∂ Start"}
                </button>
                <button onClick={pomoStop} className="flex-1 py-2 rounded-lg text-sm font-medium bg-emerald-500 hover:bg-emerald-600 text-white">‚èπ Stop & Log</button>
                <button onClick={pomoReset} className="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200 text-slate-600">‚Ü∫</button>
              </div>
              {pomoTaskId && pomoElapsed > 0 && <p className="text-xs text-slate-400 text-center mt-2">Stop will log {(pomoElapsed/3600).toFixed(2)}h to selected task</p>}
            </div>
          )}

          {showGoalForm && editGoal && (
            <Modal title={goals.find(g => g.id === editGoal.id) ? "Edit Goal" : "New Goal"} onClose={() => { setShowGoalForm(false); setEditGoal(null); }}>
              <div className="space-y-4">
                <Field label="Title"><input className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editGoal.title} onChange={e => setEditGoal({...editGoal, title: e.target.value})} placeholder="e.g. Submit paper to JMLR" /></Field>
                <div className="grid grid-cols-2 gap-3">
                  <Field label="Category"><select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editGoal.category} onChange={e => setEditGoal({...editGoal, category: e.target.value})}>{CATEGORIES.map(c => <option key={c}>{c}</option>)}</select></Field>
                  <Field label="Status"><select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editGoal.status} onChange={e => setEditGoal({...editGoal, status: e.target.value})}>{STATUSES.map(s => <option key={s}>{s}</option>)}</select></Field>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <Field label="Submission Type"><select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editGoal.sub_type || "General"} onChange={e => setEditGoal({...editGoal, sub_type: e.target.value})}>{SUB_TYPES.map(s => <option key={s}>{s}</option>)}</select></Field>
                  <Field label="Outcome"><select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editGoal.outcome || "N/A"} onChange={e => setEditGoal({...editGoal, outcome: e.target.value})}>{OUTCOMES.map(o => <option key={o}>{o}</option>)}</select></Field>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <Field label="Deadline"><input type="date" className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editGoal.deadline} onChange={e => setEditGoal({...editGoal, deadline: e.target.value})} /></Field>
                  <Field label={`Progress: ${editGoal.progress}%`}><input type="range" min="0" max="100" className="w-full mt-2" value={editGoal.progress} onChange={e => setEditGoal({...editGoal, progress: Number(e.target.value)})} /></Field>
                </div>
                <Field label="Notes / Next steps"><textarea className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" rows={2} value={editGoal.notes} onChange={e => setEditGoal({...editGoal, notes: e.target.value})} placeholder="e.g. Rejected from NeurIPS ‚Äî revising for ICML" /></Field>
                <div className="flex justify-end gap-2 pt-1">
                  <button onClick={() => { setShowGoalForm(false); setEditGoal(null); }} className="px-4 py-2 text-sm text-slate-500 hover:text-slate-700">Cancel</button>
                  <button onClick={() => saveGoal(editGoal)} className="px-4 py-2 text-sm bg-slate-800 text-white rounded-lg hover:bg-slate-700">Save</button>
                </div>
              </div>
            </Modal>
          )}

          {showTaskForm && editTask && (
            <Modal title={tasks.find(t => t.id === editTask.id) ? "Edit Task" : "New Task"} onClose={() => { setShowTaskForm(false); setEditTask(null); }}>
              <div className="space-y-4">
                <Field label="Task"><input className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editTask.title} onChange={e => setEditTask({...editTask, title: e.target.value})} placeholder="e.g. Revise introduction" /></Field>
                <div className="grid grid-cols-2 gap-3">
                  <Field label="Linked Goal">
                    <select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editTask.goal_id || ""} onChange={e => setEditTask({...editTask, goal_id: Number(e.target.value)})}>
                      <option value="">‚Äî None ‚Äî</option>
                      {goals.map(g => <option key={g.id} value={g.id}>{g.title}</option>)}
                    </select>
                  </Field>
                  <Field label="Priority"><select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editTask.priority} onChange={e => setEditTask({...editTask, priority: e.target.value})}>{PRIORITIES.map(p => <option key={p}>{p}</option>)}</select></Field>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <Field label="Time Category"><select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editTask.time_category || "Research"} onChange={e => setEditTask({...editTask, time_category: e.target.value})}>{TIME_CATS.map(c => <option key={c}>{c}</option>)}</select></Field>
                  <Field label="Est. Hours"><input type="number" min="0" step="0.5" className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editTask.est_hours} onChange={e => setEditTask({...editTask, est_hours: e.target.value})} placeholder="e.g. 2.5" /></Field>
                </div>
                <Field label="Deadline"><input type="date" className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm" value={editTask.deadline} onChange={e => setEditTask({...editTask, deadline: e.target.value})} /></Field>
                <div className="flex justify-end gap-2 pt-1">
                  <button onClick={() => { setShowTaskForm(false); setEditTask(null); }} className="px-4 py-2 text-sm text-slate-500 hover:text-slate-700">Cancel</button>
                  <button onClick={() => saveTask(editTask)} className="px-4 py-2 text-sm bg-slate-800 text-white rounded-lg hover:bg-slate-700">Save</button>
                </div>
              </div>
            </Modal>
          )}
        </div>
      );
    }

    // ‚îÄ‚îÄ Root ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function Root() {
      const [user, setUser] = useState(null);
      const [checking, setChecking] = useState(true);

      useEffect(() => {
        sb.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setChecking(false);
        });
        const { data: { subscription } } = sb.auth.onAuthStateChange((_e, session) => {
          setUser(session?.user ?? null);
        });
        return () => subscription.unsubscribe();
      }, []);

      if (checking) return (
        <div className="min-h-screen bg-slate-50 flex items-center justify-center">
          <div className="text-center text-slate-400"><div className="text-4xl mb-3">üéì</div><p>Loading...</p></div>
        </div>
      );
      return user ? <TrackerApp user={user} /> : <AuthScreen />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Root />);
  </script>
</body>
</html>
